{% include 'settings' %}
{% assign date_format = '%B %d, %Y' %}
{% assign date_time_format = '%B %d, %Y %I:%M %p %Z' %}
{% assign time_format = '%I:%M %p %Z' %}

{%- assign sidebar = 'sidebar-customers-order' -%}
{%- assign title = 'customer.order.title' | t: name: order.name -%}

{% include 'breadcrumbs' %}
{% include 'content-open' class: 'column-max no-padding-top' %}
{% include 'page-header' content: 'page-header-content-customer-order' class: 'row' col1_class: 'large-8 columns' col2_class: 'large-4 columns text-right-large' %}
{% include 'separator' %}

{%- assign order_date =  -%}
{%- assign cancelled_date = order.cancelled_at | date: date_time_format -%}

{% comment %} Order {% endcomment %}
<div class="customer-order">

  {% comment %} Meta {% endcomment %}
  <div class="order-meta small-item-grid-1 medium-item-grid-2 large-item-grid-3 lht">

    {% comment %} Order date {% endcomment %}
    <div class="item">
      <strong class="title">{{ 'customer.order.placed' | t }}</strong>
      <div>{{ order.created_at | date: date_format }}</div>
      <div>{{ order.created_at | date: time_format }}</div>
    </div>

    {% comment %} Payment status {% endcomment %}
    <div class="item">
      <strong class="title">{{ 'customer.order.payment_status' | t }}</strong>
      {{ order.financial_status_label }}
    </div>

    {% comment %} Fulfillment status {% endcomment %}
    <div class="item">
      <strong class="title">{{ 'customer.order.fulfillment_status' | t }}</strong>
      {{ order.fulfillment_status_label }}
    </div>

    {% comment %} Cancelled {% endcomment %}
    {% if order.cancelled %}
    <div class="item">
      <strong class="title">{{ 'customer.order.cancelled' | t }}</strong>
      <div>{{ order.cancelled_at | date: date_format }}</div>
      <div>{{ order.cancelled_at | date: time_format }}</div>
    </div>
    {% endif %}

    {% comment %} Cancellation reason {% endcomment %}
    {% if order.cancel_reason %}
    <div class="item">
      <strong class="title">{{ 'customer.order.cancellation_reason' | t }}</strong>
      {{ order.cancel_reason }}
    </div>
    {% endif %}

    {% comment %} Notes {% endcomment %}
    {% if order.note and order.note != blank %}
    <div class="item">
      <strong class="title">{{ 'customer.order.notes' | t }}</strong>
      {{ order.note }}
    </div>
    {% endif %}

  </div>

  {% comment %} Separator {% endcomment %}
  {% include 'separator' class: 'lined full margin-top-150 margin-bottom' %}

  {% comment %} Line items {% endcomment %}
  <div class="line-items font-size-15">
    {% for line_item in order.line_items %}

      {% comment %} Set the display style of the line price {% endcomment %}
      {% if line_item.line_level_discount_allocations.size > 0 %}
        {% assign original_price_class = 'price compare-at text-light' %}
      {% else %}
        {% assign original_price_class = 'price' %}
      {% endif %}

      {% comment %} Get the line item property size {% endcomment %}
      {%- assign property_size = line_item.properties | size -%}

      {% comment %} Line item {% endcomment %}
      <div id="{{ line_item.key }}" class="line-item">
        <div class="row">

          {% comment %} Image {% endcomment %}
          <div class="image small-12 medium-2 large-2 columns text-center">
            {% include 'image' with line_item.image, image_widths: '100, 250, 650', image_link_url: line_item.variant.url %}
          </div>

          <div class="small-7 medium-6 large-7 columns">

            {% comment %} Title {% endcomment %}
            <div class="product-title font-size-17">
              <a class="text-color" href="{{ item.url }}">{{ line_item.product.title }}</a>
            </div>

            {% comment %} SKU {% endcomment %}
            {% if line_item.sku != empty %}
              <div class="sku font-size-15 spacing-top">
                <span class="sku-label">{{ 'customer.order.sku' | t }}</span> <span data-sku>{{ line_item.sku }}</span>
              </div>
            {% endif %}

            {% comment %} Variant title {% endcomment %}
            {% unless line_item.variant.title contains 'Default' %}
              <div class="variant-title font-size-15 spacing-top">{{ line_item.variant.title }}</div>
            {% endunless %}

            {% unless line_item.selling_plan_allocation == nil  %}
                <div class="font-size-15 spacing-top">
                  {{ line_item.selling_plan_allocation.selling_plan.name }}
                </div>
              {% endunless %}

            {% comment %} Line item properties {% endcomment %}
            {% if property_size > 0 %}
              <div class="properties font-size-15 spacing-top">
                {% for p in line_item.properties %}
                  {% unless p.last == blank %}
                    <span class="property">
                      <span class="property-title">{{ p.first }}:</span>
                      {% comment %} Check if there was an uploaded file associated {% endcomment %}
                      {% if p.last contains '/uploads/' %}
                        <a href="{{ p.last }}" data-target-new>{{ 'general.forms.file' | t }}</a>
                      {% else %}
                        {{ p.last }}
                      {% endif %}
                    </span>
                  {% endunless %}
                {% endfor %}
              </div>
            {% endif %}

            {% comment %} Discounts {% endcomment %}
            {% if line_item.line_level_discount_allocations.size > 0 %}
              <div class="discounts text-light font-size-13 spacing-top">
                {% for allocation in line_item.line_level_discount_allocations %}
                  <div class="discount">
                    <i class="fa fa-tags"></i> {{ allocation.discount_application.title }} (-{% include 'price' amount: allocation.discount_application.total_allocated_amount, class: '' %})</div>
                {% endfor %}
              </div>
            {% endif %}

            {% comment %} Fulfillment {% endcomment %}
            {% if line_item.fulfillment %}
              {% include 'separator' class: 'lined no-margin-left' %}

              <div class="fulfillment">
                {%- assign fulfilled_at = line_item.fulfillment.created_at | date: date_format -%}
                <span>{{ 'customer.order.fulfilled_at' | t: date: fulfilled_at }}</span></br>
                {% if line_item.fulfillment.tracking_number %}
                  <a href="{{ line_item.fulfillment.tracking_url }}" data-target-new>{{ line_item.fulfillment.tracking_company }} #{{ line_item.fulfillment.tracking_number}}</a>
                {% endif %}
              </div>
            {% endif %}
            
          </div>

          <div class="pricing small-5 medium-4 large-3 columns text-right">

            {% comment %} Price {% endcomment %}
            <span class="line-price-calc font-size-13">
              {{ line_item.quantity }} x <span>{% include 'price' amount: line_item.original_price, class: 'price item-price' %}</span>
            </span>

            {% include 'price' amount: line_item.original_line_price, class: original_price_class %}

            {% if line_item.line_level_discount_allocations.size > 0 %}
              {% include 'price' amount: line_item.final_line_price, class: 'price' %}
            {% endif %}

            {%- if line_item.unit_price_measurement -%}
              {%- capture unit_price_separator -%}
                <span class="price per-unit text-light font-size-12" aria-hidden="true">&sol;</span><span class="visually-hidden">{{ 'products.per' | t }}</span>
              {%- endcapture -%}
              {%- capture unit_price_base_unit -%}
                <span class="price per-unit text-light font-size-12">
                  {%- if line_item.unit_price_measurement.reference_value != 1 -%}
                    {{- line_item.unit_price_measurement.reference_value -}}
                  {%- endif -%}
                  {{- line_item.unit_price_measurement.reference_unit -}}
                </span>
              {%- endcapture -%}
              <br/>
              {%- include 'price', amount: line_item.unit_price, class: 'price per-unit text-light font-size-12' -%}{{- unit_price_separator -}}{{- unit_price_base_unit -}}
            {%- endif -%}

          </div>
        </div>
      </div>

      {% comment %} Separator {% endcomment %}
      {% include 'separator' class: 'lined full margin-top margin-bottom' %}

    {% endfor %}
  </div>

  {% comment %} Separator {% endcomment %}
  {% include 'separator' %}

  {% comment %} Totals {% endcomment %}
  <div class="order-totals lht">

    {% comment %} Subtotal {% endcomment %}
    <div class="subtotal row text-center text-right-medium">
      <div class="medium-6 large-8 columns label">
        {{ 'customer.order.subtotal' | t }}
      </div>
      <div class="medium-6 large-4 columns amount">
        {% include 'price' amount: order.line_items_subtotal_price, class: 'price order-subtotal' %}
      </div>
    </div>

    {% comment %} Discounts {% endcomment %}
    {% if order.cart_level_discount_applications.size > 0 %}
      {% for discount_application in order.cart_level_discount_applications %}
        <div class="discount row text-center text-right-medium">
          <div class="medium-6 large-8 columns label">
            <span class="discounts-title">{{ 'customer.order.discount' | t }}</span> ({{ discount_application.title }})
          </div>
          <div class="medium-6 large-4 columns amount">
            -{% include 'price' amount: discount_application.total_allocated_amount %}
          </div>
        </div>
      {% endfor %}
    {% endif %}

    {% comment %} Shipping {% endcomment %}
    {% for shipping_method in order.shipping_methods %}
      <div class="discount row text-center text-right-medium">
        <div class="medium-6 large-8 columns label">
          {{ 'customer.order.shipping' | t: shipping_method: shipping_method.title }}
        </div>
        <div class="medium-6 large-4 columns amount">
          {% include 'price' amount:  shipping_method.price, class: 'price order-discount' %}
        </div>
      </div>
    {% endfor %}

    {% comment %} Tax {% endcomment %}
    {% for tax_line in order.tax_lines %}
      {%- assign tax_rate = tax_line.rate | times: 100 -%}
      <div class="tax row text-center text-right-medium">
        <div class="medium-6 large-8 columns label">
          {{ 'customer.order.tax' | t: tax_title: tax_line.title, tax_rate: tax_rate }}
        </div>
        <div class="medium-6 large-4 columns amount">
          {% include 'price' amount:  tax_line.price, class: 'price order-tax' %}
        </div>
      </div>
    {% endfor %}

    {% comment %} Total {% endcomment %}
    <div class="total row text-center text-right-medium">
      <div class="medium-6 large-8 columns label">
        <strong class="font-size-17">{{ 'customer.order.total' | t }}</strong>
      </div>
      <div class="medium-6 large-4 columns amount">
        {{ order.currency }}
        <strong class="font-size-17">{% include 'price' amount:  order.total_price, class: 'price order-total' %}</strong>
      </div>
    </div>

  </div>

</div>

{% include 'content-close' %}

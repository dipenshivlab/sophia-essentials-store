{%- comment -%}
  version: 0.0.0
{%- endcomment -%}
{%- comment -%}
  ----------------------------------------------------------------------------------
   Plug in SEO SEO fixes for Shopify
   Copyright (c) 2018 Pemberton Rank Ltd, a company registered in England 7341337
   This file is subject to the license at https://www.pluginseo.com/eula
  ----------------------------------------------------------------------------------
{%- endcomment -%}
{%- assign licensedTo = 'SEO fixes customer' -%}
{%- assign pluginseoVerbose = false -%}
{%- assign pageUnderscoreTitle = 'page' | append: '_' | append: 'title' -%}
{%- assign pageUnderscoreDescription = 'page' | append: '_' | append: 'description' -%}
{%- comment -%}
  ----------------------------------------------------------------------------------
   Langify
  ----------------------------------------------------------------------------------
{%- endcomment -%}
{%- assign hasLangify = false -%}
{%- assign rootTemplate = template | split: '.' | first -%}
{%- capture langifyGlobal -%}{%- include 'ly-global' -%}{%- endcapture -%}
{%- unless langifyGlobal contains "Liquid error: Could not find asset snippets/ly-global.liquid" -%}
  {%- assign hasLangify = true -%}
{%- endunless -%}
{%- if hasLangify == true -%}
  {%- for language in shop.metafields.languages -%}
    {%- assign langKey = language | first -%}
    {%- if langKey != "default" -%}
      {%- assign langValue = language | last -%}
      {%- assign current_url = nil -%}
      {%- case rootTemplate -%}
        {%- when 'index' -%}
          {%- assign current_url = '' -%}
        {%- when 'page' -%}
          {%- assign current_url = page.url -%}
        {%- when 'blog' -%}
          {%- assign current_url = blog.url -%}
        {%- when 'article' -%}
          {%- assign current_url = article.url -%}
        {%- when 'collection' -%}
          {%- assign current_url = collection.url -%}
        {%- when 'product' -%}
          {%- assign current_url = product.url -%}
      {%- endcase -%}
      {%- if current_url != nil -%}
        {%- assign splitDomains = shop.metafields.language_domains[langKey] | split: ',' -%}
        {%- assign languageDomain = product.url -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
  {%- if request.host -%}
    {%- assign host = request.host -%}
    {%- assign domains = shop.metafields.language_domains -%}
    {%- for domain in domains -%}
      {%- assign key = domain | first -%}
      {%- assign value = domain | last | split: ',' -%}
      {%- if value contains host -%}
        {%- assign detectedLanguage = key -%}
      {%- endif -%}
    {%- endfor -%}
    {%- if detectedLanguage == nil -%}
      {%- assign detectedLanguage = shop.metafields["languages"]["default"] -%}
    {%- endif -%}
  {%- else -%}
    {%- assign detectedLanguage = cart.attributes["language"] -%}
    {%- if detectedLanguage == nil -%}
      {%- assign detectedLanguage = shop.metafields["languages"]["default"] -%}
    {%- endif -%}
  {%- endif -%}
{%- endif -%}
{%- comment -%}
  ----------------------------------------------------------------------------------
  Page title
  ----------------------------------------------------------------------------------
{%- endcomment -%}
{%- assign pTF = 's' -%}
{%- assign pageTitleManuallyEntered = true -%}
{%- assign defaultPageTitle = nil -%}
{%- comment -%}
{%- if hasLangify == true and detectedLanguage != shop.metafields["languages"]["default"] -%}
  {%- assign pTF = pTF | append: '-lf' -%}
  {%- if rootTemplate == 'index' -%}
    <title>[Homepage page title]</title>
  {%- elsif rootTemplate == '404' -%}
    <title>[404 page title]</title>
  {%- elsif rootTemplate == 'search' -%}
    <title>[Search page title]</title>
  {%- else -%}
    {%- assign pTF = pTF | append: '-ap' -%}
    <title> {{ langify_title | strip_html | strip_newlines }} [Append]</title>
  {%- endif -%}
{%- else -%}
  {%- case rootTemplate -%}
    {%- when 'index' -%}
      {%- assign defaultPageTitle = ['shop']['name'] -%}
      {%- assign pageTitleTemplate = settings.pluginseo_pageTitleIndexTemplate -%}
      {%- assign pTFTemp = '-te_ix' -%}
    {%- when 'page' -%}
      {%- assign defaultPageTitle = page.title -%}
      {%- assign pageTitleTemplate = settings.pluginseo_pageTitlePageTemplate -%}
      {%- assign pTFTemp = '-te_pg' -%}
    {%- when 'search' -%}
      {%- if search.terms == empty -%}
        {%- assign defaultPageTitle = 'Search' -%}
      {%- else -%}
        {%- assign defaultPageTitle = search.terms -%}
      {%- endif -%}
      {%- assign pageTitleTemplate = settings.pluginseo_pageTitleSearchTemplate -%}
      {%- assign pTFTemp = '-te_se' -%}
    {%- when 'product' -%}
      {%- assign defaultPageTitle = product.title -%}
      {%- assign pageTitleTemplate = settings.pluginseo_pageTitleProductTemplate -%}
      {%- assign pTFTemp = '-te_pr' -%}
    {%- when 'collection' -%}
      {%- assign defaultPageTitle = collection.title -%}
      {%- assign pageTitleTemplate = settings.pluginseo_pageTitleCollectionTemplate -%}
      {%- assign pTFTemp = '-te_co' -%}
    {%- when 'blog' -%}
      {%- assign defaultPageTitle = blog.title -%}
      {%- assign pageTitleTemplate = settings.pluginseo_pageTitleBlogTemplate -%}
      {%- assign pTFTemp = '-te_bl' -%}
    {%- when 'article' -%}
      {%- assign defaultPageTitle = article.title -%}
      {%- assign pageTitleTemplate = settings.pluginseo_pageTitleArticleTemplate -%}
      {%- assign pTFTemp = '-te_ar' -%}
    {%- when '404' -%}
      {%- assign pageTitleTemplate = settings.pluginseo_pageTitle404Template -%}
      {%- assign pTFTemp = '-te_44' -%}
    {%- else -%}
  {%- endcase -%}
  {%- capture defaultPageTitle -%}{{ defaultPageTitle | truncate: 70, "" | strip_html | escape }}{%- endcapture -%}
  {%- if [pageUnderscoreTitle] == blank or [pageUnderscoreTitle] == nil or [pageUnderscoreTitle] == defaultPageTitle  -%}
    {%- assign pageTitleManuallyEntered = false -%}
  {%- endif -%}
  {%- if pageTitleTemplate == blank or pageTitleTemplate == nil -%}
    {%- assign pageTitleTemplate = settings.pluginseo_pageTitleDefaultTemplate -%}
    {%- assign pTFTemp = '-te_df' -%}
  {%- endif -%}
  {%- if pageTitleTemplate != nil -%}
    {%- if pageTitleManuallyEntered == false or settings.pluginseo_pageTitleTemplateApplyToAll == true -%}
      {%- assign pTF = pTF | append: pTFTemp -%}
      {%- capture pageTitle -%}{%- include 'pluginseo-parse' template:pageTitleTemplate -%}{%- endcapture -%}
    {%- else -%}
      {%- assign pTF = pTF | append: '-me' -%}
      {%- capture pageTitle -%}{%- include 'pluginseo-parse' template:[pageUnderscoreTitle] -%}{%- endcapture -%}
    {%- endif -%}
  {%- else -%}
    {%- assign pTF = pTF | append: '-me' -%}
    {%- capture pageTitle -%}{%- include 'pluginseo-parse' template:[pageUnderscoreTitle] -%}{%- endcapture -%}
  {%- endif -%}
  {%- if settings.pluginseo_pageTitleEnableAppender == true -%}
    {%- capture pageTitleAppend -%}{%- include 'pluginseo-parse' template:settings.pluginseo_pageTitleAppenderTemplate -%}{%- endcapture -%}
    {%- capture pageTitleWithAppendage -%}{{ pageTitle }} {{ pageTitleAppend }}{%- endcapture -%}
    {%- assign pluginseo_pageTitleTruncateChars = settings.pluginseo_pageTitleTruncateChars | plus: 0 -%}
    {%- assign pluginseo_pageTitleAppenderTargetLength = settings.pluginseo_pageTitleAppenderTargetLength | plus: 0 -%}
    {%- assign pageTitleLength = pageTitle | size | plus: 0 -%}
    {%- assign pageTitleWithAppendageLength = pageTitleWithAppendage | size | plus: 0 -%}
    {%- if pageTitleLength < pluginseo_pageTitleAppenderTargetLength and pageTitleWithAppendageLength < pluginseo_pageTitleTruncateChars -%}
      {%- assign pTF = pTF | append: '-ap' -%}
      {%- capture pageTitle -%}{{ pageTitleWithAppendage }}{%- endcapture -%}
    {%- endif -%}
  {%- endif -%}
  {%- if settings.pluginseo_pageTitleTruncateChars != nil -%}
    {%- assign finalPageTitleLength = pageTitle | size | plus: 0 -%}
    {%- assign pluginseo_pageTitleTruncateChars = settings.pluginseo_pageTitleTruncateChars | plus: 0 -%}
    {%- if finalPageTitleLength > pluginseo_pageTitleTruncateChars -%}
      {%- assign pTF = pTF | append: '-tr' -%}
    {%- endif -%}
    {%- capture pageTitle -%}{{ pageTitle | truncate: settings.pluginseo_pageTitleTruncateChars, "" }}{%- endcapture -%}
  {%- endif -%}
  <title>{{ pageTitle | strip_html | strip_newlines }}</title>
{%- endif -%}
{%- endcomment -%}
{%- comment -%}
  ----------------------------------------------------------------------------------
  Meta description
  ----------------------------------------------------------------------------------
{%- endcomment -%}
{%- assign mDF = 's' -%}
{%- assign metaDescriptionManuallyEntered = true -%}
{%- assign defaultMetaDescription = nil -%}
{%- if hasLangify == true and detectedLanguage != shop.metafields["languages"]["default"] -%}
  {%- assign mDF = mDF | append: '-lf' -%}
  {%- if rootTemplate == 'index' -%}
    <meta name="description" content="[Homepage meta description]" />
  {%- elsif rootTemplate == '404' -%}
    <meta name="description" content="[404 meta description]" />
  {%- elsif rootTemplate == 'search' -%}
    <meta name="description" content="[Search meta description]" />
  {%- else -%}
    <meta name="description" content="{{ langify_description }}" />
  {%- endif -%}
{%- else -%}
  {%- case rootTemplate -%}
    {%- when 'index' -%}
      {%- assign defaultMetaDescription = ['shop']['description'] -%}
      {%- assign metaDescriptionTemplate = settings.pluginseo_metaDescriptionIndexTemplate -%}
      {%- assign mDFTemp = '-te_ix' -%}
    {%- when 'page' -%}
      {%- assign defaultMetaDescription = page.content -%}
      {%- assign metaDescriptionTemplate = settings.pluginseo_metaDescriptionPageTemplate -%}
      {%- assign mDFTemp = '-te_pg' -%}
    {%- when 'search' -%}
      {%- assign defaultMetaDescription = ['shop']['description'] -%}
      {%- assign metaDescriptionTemplate = settings.pluginseo_metaDescriptionSearchTemplate -%}
      {%- assign mDFTemp = '-te_se' -%}
    {%- when 'product' -%}
      {%- assign defaultMetaDescription = product.description -%}
      {%- assign metaDescriptionTemplate = settings.pluginseo_metaDescriptionProductTemplate -%}
      {%- assign mDFTemp = '-te_pr' -%}
    {%- when 'collection' -%}
      {%- assign defaultMetaDescription = collection.description -%}
      {%- assign metaDescriptionTemplate = settings.pluginseo_metaDescriptionCollectionTemplate -%}
      {%- assign mDFTemp = '-te_co' -%}
    {%- when 'blog' -%}
      {%- assign metaDescriptionTemplate = settings.pluginseo_metaDescriptionBlogTemplate -%}
      {%- assign mDFTemp = '-te_bl' -%}
    {%- when 'article' -%}
      {%- assign defaultMetaDescription = article.content -%}
      {%- assign metaDescriptionTemplate = settings.pluginseo_metaDescriptionArticleTemplate -%}
      {%- assign mDFTemp = '-te_ar' -%}
    {%- when '404' -%}
      {%- assign metaDescriptionTemplate = settings.pluginseo_metaDescription404Template -%}
      {%- assign mDFTemp = '-te_44' -%}
    {%- else -%}
  {%- endcase -%}
  {%- capture pageUnderscoreDescriptionForCompare -%}{{ [pageUnderscoreDescription] | replace: ' ','' }}{%- endcapture -%}
  {%- capture truncateLength -%}{{ pageUnderscoreDescriptionForCompare | size }}{%- endcapture -%}
  {%- capture defaultMetaDescriptionForCompare -%}{{ defaultMetaDescription | replace: ' ','' | strip_newlines | strip_html | escape | truncate: truncateLength, '' }}{%- endcapture -%}
  {%- if pluginseoVerbose == true -%}
  <!-- pageUnderscoreDescriptionForCompare: {{ pageUnderscoreDescriptionForCompare }} -->
  <!-- defaultMetaDescriptionForCompare   : {{ defaultMetaDescriptionForCompare }} -->
  {%- endif -%}
  {%- if [pageUnderscoreDescription] == blank or [pageUnderscoreDescription] == nil or pageUnderscoreDescriptionForCompare == defaultMetaDescriptionForCompare -%}
    {%- assign metaDescriptionManuallyEntered = false -%}
  {%- endif -%}
  {%- if metaDescriptionTemplate == blank or metaDescriptionTemplate == nil -%}
    {%- assign metaDescriptionTemplate = settings.pluginseo_metaDescriptionDefaultTemplate -%}
    {%- assign mDFTemp = '-te_df' -%}
  {%- endif -%}
  {%- if metaDescriptionTemplate != nil -%}
    {%- if metaDescriptionManuallyEntered == false or settings.pluginseo_metaDescriptionTemplateApplyToAll == true -%}
      {%- assign mDF = mDF | append: mDFTemp -%}
      {%- capture metaDescription -%}{%- include 'pluginseo-parse' template:metaDescriptionTemplate -%}{%- endcapture -%}
    {%- else -%}
      {%- assign mDF = mDF | append: '-me' -%}
      {%- capture metaDescription -%}{%- include 'pluginseo-parse' template:[pageUnderscoreDescription] -%}{%- endcapture -%}
    {%- endif -%}
  {%- else -%}
    {%- assign mDF = mDF | append: '-me' -%}
    {%- capture metaDescription -%}{%- include 'pluginseo-parse' template:[pageUnderscoreDescription] -%}{%- endcapture -%}
  {%- endif -%}
  {%- if settings.pluginseo_metaDescriptionTruncateChars != nil -%}
    {%- assign finalMetaDescription = metaDescription | size | plus: 0 -%}
    {%- assign pluginseo_metaDescriptionTruncateChars = settings.pluginseo_metaDescriptionTruncateChars | plus: 0 -%}
    {%- if finalMetaDescription > pluginseo_metaDescriptionTruncateChars -%}
      {%- assign mDF = mDF | append: '-tr' -%}
    {%- endif -%}
    {%- capture metaDescription -%}{{ metaDescription | truncate: settings.pluginseo_metaDescriptionTruncateChars, "" }}{%- endcapture -%}
  {%- endif -%}
  {%- if metaDescription != blank -%}
    <meta name="description" content="{{ metaDescription | strip_html | strip_newlines }}" />
  {%- endif -%}
{%- endif -%}
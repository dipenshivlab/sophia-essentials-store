{% include 'settings' %}

{%- if section.settings.show_product_recommendations -%}

  {%- assign product_limit = section.settings.products_per_row | times: section.settings.product_rows -%}

  {% if section.settings.width == 'width-100' %}
    {%- assign section_class = 'width-100 body-padding' %}
  {% else %}
    {%- assign section_class = 'column-max' %}
  {% endif %}

  {%- assign per_row_small = 2 -%}


  <div class="product-recommendations mt-200" data-product-id="{{ product.id }}" data-limit="{{ product_limit }}">

    {% comment %}
      Open section
    {% endcomment %}
    {% include 'section-open' section_type: 'product-recommendations', class: section_class, show_title: true, title: section.settings.heading %}

    {% comment %}
      CSS
    {% endcomment %}
    <style>
      #{{ section_id }} .section-title {
        text-align: {{ section.settings.align_heading }};
      }
    </style>

    {% comment %}
      Products
    {% endcomment %}
    {%- if recommendations.products_count > 0 -%}
      {% include 'products' with recommendations.products, class: 'row-spacing-150', limit: product_limit, show_add_to_cart_button: section.settings.show_add_to_cart_button, show_compare_at_price: section.settings.show_compare_at_price, show_price: section.settings.show_price, show_sale_sticker: section.settings.show_sale_sticker, show_vendor: section.settings.show_vendor %}
    {%- endif -%}

    {% comment %}
      Close section
    {% endcomment %}
    {% include 'section-close'  %}

  </div>

{%- endif -%}


{% javascript %}
  function loadProductRecommendationsIntoSection() {
    var productRecommendationsSection = document.querySelector('.product-recommendations');
    if (productRecommendationsSection === null) {
      return;
    };
    var productId = productRecommendationsSection.dataset.productId;
    var limit = productRecommendationsSection.dataset.limit;
    var requestUrl = Station.Theme.shop.root + 'recommendations/products?section_id=product-recommendations&limit='+limit+'&product_id=' + productId;
    var request = new XMLHttpRequest();
    request.open('GET', requestUrl);
    request.onload = function () {
      if (request.status >= 200 && request.status < 300) {
        var container = document.createElement('div');
        container.innerHTML = request.response;
        productRecommendationsSection.parentElement.innerHTML = container.querySelector('.product-recommendations').innerHTML;
        window.Station.Theme.Currency.init();
        window.Station.Theme.Cart.init();
      };
    };
    request.send();
  };
  document.addEventListener('DOMContentLoaded', function (event) {
    loadProductRecommendationsIntoSection();
  });
  document.addEventListener('shopify:section:load', function (event) {
    if (event.detail.sectionId === 'product-recommendations') {
      loadProductRecommendationsIntoSection();
    };
  });
{% endjavascript %}


{% comment %}
  Schema
{% endcomment %}
{% schema %}
{
  "name": "Product recommendations",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_product_recommendations",
      "label": "Show dynamic recommendations",
      "info": "Dynamic recommendations change and improve with time. [Learn more](https://help.shopify.com/en/themes/development/recommended-products)",
      "default": true
    },
    {
      "id": "width",
      "type": "select",
      "label": "Width",
      "options": [
        {"value": "column-max", "label": "Content"},
        {"value": "width-100", "label": "Screen"}
      ]
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "You may also like"
    },
    {
      "id": "align_heading",
      "type": "select",
      "label": "Heading alignment",
      "options": [
        {"value": "left", "label": "Left"},
        {"value": "center", "label": "Center"},
        {"value": "right", "label": "Right"}
      ]
    },
    {
      "type": "range",
      "id": "products_per_row",
      "label": "Products per row",
      "min": 1,
      "max": 8,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "product_rows",
      "label": "Rows",
      "min": 1,
      "max": 10,
      "step": 1,
      "default": 1
    },
    {
      "type": "header",
      "content": "Products"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Show vendor",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_price",
      "label": "Show price",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_compare_at_price",
      "label": "Show compare at price",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_add_to_cart_button",
      "label": "Show add to cart button",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_sale_sticker",
      "label": "Show sale sticker",
      "default": true,
      "info": "Shown when product has 'compare at' price higher than 'price'"
    },
    {
      "type": "color",
      "id": "bg_details_color",
      "label": "Details background",
      "default": "#ffffff"
    }
  ],
  "presets": [
    {
      "name": "Product recommendations",
      "category": "Products",
      "settings": {
        "width": "column-max",
        "products_per_row": 4,
        "product_rows": 1,
        "show_vendor": true,
        "show_price": true,
        "show_compare_at_price": true,
        "show_add_to_cart_button": true,
        "show_sale_sticker": true
      }
    }
  ]
}
{% endschema %}
